## Задание 1. Повышение безопасности системы

### Задача 1. Предложите архитектурное решение и доработайте диаграмму C4 для управления учётными данными пользователя.

Решение должно учитывать и обеспечивать следующие аспекты:
- Унификацию доступа в системе BionicPRO. Это будет осуществляться через запрос данных учётных записей из внешнего
источника, который расположен в стране представительства компании. Принципы локального хранения персональной и
медицинской информации не должны быть нарушены.
- Безопасную схему работы с access- и refresh-токенами, которая исключает передачу фронтенду токенов, которые были
получены от IdP.
- Возможность поддержки аутентификации пользователей через различные внешние удостоверяющие службы, действующие в разных
странах.

Для подготовки архитектуры решения используйте [draw.io.](README.assets/BionicPRO_C4_model.drawio)

### Задача 2. Улучшите безопасность существующего приложения, заменив Code Grant на PKCE.
Его нужно добавить к уже существующим приложениям — фронтенду и Keycloak. Мы неслучайно не рассказывали в теории, как
это сделать. Чтобы разобраться, изучите официальную документацию.

### Задача 3. Обеспечьте безопасное получение и хранение access-и refresh-токенов.
1. Перенесите механизм запроса access- и refresh-токен из фронтенда в новый бэкенд-сервис, который реализует интеграцию с
Keycloak и работу с сессиями.
2. Назовите сервер bionicpro-auth. Написать его можно на любом из стандартных для бэкенда языков — Java, C#, Go, Python.
Можно использовать либы и фреймворки.
3. Ограничений по выбору языка нет. Можно использовать фреймворки и библиотеки для реализации задания, например, для Java —
Spring Security.
4. Настройте Keycloak на работу с refresh_token. Установите время работы access_token — не более 2 минут.
5. При успешной авторизации на бэкенде сохраните refresh_token на защищённом хранилище или в зашифрованном виде в
оперативной памяти, или в распределённом кеше.
6. Сохраните access_token в оперативной памяти сервера либо в распределённом кеше.
7. Обеспечьте привязку access_token и refresh_token к сессии.
8. ответе фронтенду вместо токенов отдайте сессионную cookie c HTTP-only и Secure-флагами.
9. Время жизни сессии должно быть больше времени жизни access_token, чтобы при истечении access_token можно было обновить
access_token через refresh_token.
10. Обновите код фронтенд-приложения, убрав из него механизм получения токенов и сделав обязательным прокидывание на
бэкенд сессионной cookie.
11. Если access_token устареет, то сервис сам должен сходить за новым в keycloak, используя refresh token.
12. Реализуйте ротацию сессии в рамках действующего access_token для предотвращения session fixation attack. Для этого
при очередном запросе к защищённому ресурсу при успешной проверке сессии на сервисе он перепривязывает access_token
и refresh_token к новому session id, обновляет cookie и возвращает новый session id в ответе фронтенду.

### Задача 4. Добавьте LDAP для возможности получения данных о пользователях представительства BionicPRO в другой стране.

1. Разверните LDAP-сервер OpenLDAP. Файл конфигурации развёртывания и также файл ldif с пользователями и ролями лежит в
    репозитории спринта.
2. Настройте Keycloak, чтобы он ходил в LDAP-сервер за авторизацией пользователей.
3. Добавьте маппинг ролей для синхронизации ролей разных представительств BionicPRO.

### Задача 5. Настройте MFA.
1. Настройте в Keycloak механизм OTP-аутентификации.
2. Включите обязательный ввод одноразового пароля для всех пользователей.
3. Убедитесь, что под пользователем можно войти в систему только после ввода одноразового пароля из Google
Authenticator или FreeOTP.

### Задача 6. Добавьте OAuth 2.0 от Яндекс ID.
1. Используя механизм Identity Brokering, реализуйте аутентификацию пользователей через внешний Identity Prodider
    Яндекс ID. Обратите внимание, что сервис протезов получает данные профиля пользователя из Яндекса.
2. После аутентификации сервис должен спрашивать пользователя о разрешении использовать данные.
3. Сервис должен запрашивать у Яндекса данные профиля и сохранять их в БД.
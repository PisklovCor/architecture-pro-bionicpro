# Архитектурное решение для управления учётными данными пользователя

## Обзор решения

Архитектура обеспечивает безопасное управление учётными данными с учётом требований:
- Унификация доступа через внешние источники данных
- Безопасная работа с токенами без передачи их фронтенду
- Поддержка множественных внешних IdP для разных стран

## Компоненты системы

### 1. BionicPRO Auth Service (bionicpro-auth)
**Назначение**: Централизованный сервис аутентификации и управления сессиями

**Функции**:
- Интеграция с Keycloak для получения токенов
- Управление сессиями пользователей
- Хранение токенов в защищённом хранилище (Redis)
- Ротация сессий для предотвращения session fixation
- Автоматическое обновление access_token через refresh_token

**Безопасность**:
- Токены хранятся только на бэкенде (в Redis с шифрованием)
- Фронтенд получает только HTTP-only Secure cookies
- Ротация session ID при каждом запросе

### 2. Keycloak Identity Provider
**Назначение**: Централизованный провайдер идентичности

**Функции**:
- Аутентификация через LDAP (для локальных пользователей)
- Identity Brokering для внешних IdP (Яндекс ID, другие)
- MFA через OTP
- Управление ролями и маппинг ролей между системами

**Интеграции**:
- LDAP (OpenLDAP) - для пользователей представительств
- Яндекс ID - через Identity Brokering
- Возможность добавления других IdP для разных стран

### 3. LDAP Server (OpenLDAP)
**Назначение**: Хранилище учётных данных пользователей представительств

**Функции**:
- Хранение пользователей и групп
- Синхронизация с Keycloak
- Маппинг ролей между LDAP и Keycloak

### 4. Redis Cache
**Назначение**: Хранилище сессий и токенов

**Функции**:
- Хранение access_token и refresh_token
- Привязка токенов к session ID
- TTL для токенов и сессий

### 5. Frontend Application
**Назначение**: Клиентское приложение

**Изменения**:
- Удалена прямая интеграция с Keycloak
- Все запросы идут через bionicpro-auth
- Использование HTTP-only Secure cookies для сессий

## Поток аутентификации

### 1. Первичная аутентификация
```
Frontend → bionicpro-auth → Keycloak → LDAP/Яндекс ID
         ← HTTP-only cookie ← access_token ← refresh_token
```

### 2. Запрос к защищённому ресурсу
```
Frontend → bionicpro-auth (с cookie)
         → Проверка сессии
         → Ротация session ID (если нужно)
         → Обновление access_token (если истёк)
         → Запрос к API с access_token
```

### 3. Обновление токена
```
bionicpro-auth обнаруживает истёкший access_token
→ Использует refresh_token для получения нового
→ Обновляет сессию в Redis
→ Возвращает обновлённую cookie
```

## Безопасность

### Токены
- Access token: TTL 2 минуты, хранится в Redis
- Refresh token: TTL больше сессии, хранится в Redis в зашифрованном виде
- Токены никогда не передаются фронтенду

### Сессии
- HTTP-only cookies (недоступны из JavaScript)
- Secure flag (только HTTPS в продакшене)
- Ротация session ID для предотвращения session fixation
- TTL сессии больше TTL access_token

### MFA
- Обязательный OTP для всех пользователей
- Поддержка Google Authenticator и FreeOTP

## Унификация доступа

### Локальные пользователи (Россия)
- Аутентификация через LDAP
- Роли синхронизируются из LDAP в Keycloak

### Внешние пользователи (другие страны)
- Identity Brokering через Keycloak
- Поддержка различных IdP для разных стран
- Маппинг ролей между внешними IdP и внутренней системой

## Соответствие требованиям

✅ Унификация доступа через внешние источники
✅ Локальное хранение персональных и медицинских данных
✅ Токены не передаются фронтенду
✅ Поддержка множественных внешних IdP
✅ Безопасное хранение токенов
✅ Ротация сессий
✅ MFA для всех пользователей


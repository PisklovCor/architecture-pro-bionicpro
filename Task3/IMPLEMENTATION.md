# Реализация задания 3: Снижение нагрузки на базу данных

## Обзор решения

Реализован механизм кеширования отчётов в объектном хранилище S3 (Minio) с раздачей через CDN (Nginx). Это позволяет:
- Снизить нагрузку на OLAP-базу данных (ClickHouse)
- Исключить повторные запросы для уже сформированных отчётов
- Ускорить доступ к отчётам через кеширование в CDN

## Архитектура решения

```
[Frontend] 
    ↓
[ReportController] → Проверка S3 → [S3Service] → [Minio S3]
    ↓ (если нет в S3)                    ↓
[ReportService] → [ClickHouse]      [ReportFileService] → Генерация JSON
    ↓                                          ↓
[Сохранение в S3] ←───────────────────────────┘
    ↓
[Nginx CDN] → Кеширование → [Отдача файлов]
```

## Компоненты решения

### 1. Minio (S3-совместимое хранилище)

**Конфигурация:**
- Endpoint: `http://minio:9000` (внутренняя сеть)
- Bucket: `reports`
- Доступ: через Minio Client API с credentials

**Структура хранения:**
```
reports/
  └── {userId}/
      └── {startDate}_{endDate}/
          └── report.json
```

**Преимущества структуры:**
- Быстрый доступ по userId
- Организация по периодам
- Легко найти отчёты за конкретный период

### 2. S3Service

**Функциональность:**
- Инициализация bucket при старте приложения
- Проверка существования объекта в S3
- Сохранение объектов в S3
- Получение объектов из S3
- Генерация ключей объектов

**Методы:**
- `objectExists(String objectKey)` - проверка существования объекта
- `putObject(String objectKey, byte[] data, String contentType)` - сохранение объекта
- `getObject(String objectKey)` - получение объекта
- `generateReportKey(String userId, String startDate, String endDate)` - генерация ключа

### 3. ReportFileService

**Функциональность:**
- Генерация JSON-файлов отчётов из данных
- Форматирование данных с использованием Jackson
- Поддержка Java Time API для дат

**Методы:**
- `generateReportJson(String userId, LocalDate startDate, LocalDate endDate, List<ProsthesisReport> reports)` - генерация JSON

### 4. ReportService (обновлён)

**Новая функциональность:**
- Проверка наличия отчёта в S3 перед запросом к ClickHouse
- Генерация отчёта только если его нет в S3
- Автоматическое сохранение сгенерированных отчётов в S3

**Методы:**
- `getOrGenerateReportKey(String userId, LocalDate startDate, LocalDate endDate)` - получение или генерация отчёта

**Логика работы:**
1. Проверка существования отчёта в S3 по ключу
2. Если отчёт существует - возврат ключа
3. Если отчёта нет:
   - Получение данных из ClickHouse
   - Генерация JSON-файла
   - Сохранение в S3
   - Возврат ключа

### 5. ReportController (обновлён)

**Изменения:**
- Возвращает CDN-ссылку вместо данных отчёта
- Новый endpoint `/api/reports/files/reports/**` для получения файлов из S3

**Endpoints:**
- `GET /api/reports` - получение CDN-ссылки на отчёт
- `GET /api/reports/files/reports/**` - получение файла отчёта из S3 (для CDN)

**Ответ API:**
```json
{
  "userId": "user123",
  "startDate": "2024-01-01",
  "endDate": "2024-01-31",
  "reportUrl": "http://localhost:8083/reports/user123/2024-01-01_2024-01-31/report.json",
  "message": "Report is available at the provided URL"
}
```

### 6. Nginx CDN

**Конфигурация:**
- Порт: `8083`
- Кеширование: 1 час для успешных ответов (200)
- Кеш-зона: `reports_cache` (1GB, 60 минут inactive)

**Функциональность:**
- Проксирование запросов к reports service
- Кеширование ответов от reports service
- Заголовки кеширования: `Cache-Control: public, max-age=3600`
- Статус кеша в заголовке: `X-Cache-Status`

**Логика работы:**
1. Запрос приходит на Nginx
2. Nginx проверяет кеш
3. Если в кеше - отдаёт из кеша
4. Если нет - проксирует к reports service
5. Reports service получает файл из S3
6. Nginx кеширует ответ и отдаёт клиенту

## Механизм обновления кеша

### Стратегия кеширования

1. **S3 (Minio):**
   - Отчёты хранятся постоянно до явного удаления
   - Обновление происходит при генерации нового отчёта (перезапись)

2. **Nginx CDN:**
   - TTL кеша: 1 час
   - Автоматическая инвалидация через TTL
   - Возможность ручной инвалидации через удаление из кеша

### Обновление отчётов

При обновлении данных через ETL:
1. Новые данные загружаются в ClickHouse
2. При следующем запросе отчёта:
   - Если период изменился - генерируется новый отчёт
   - Если период тот же, но данные обновились - можно добавить версионирование

**Рекомендации для будущего:**
- Добавить версионирование отчётов (например, по дате генерации)
- Реализовать механизм инвалидации кеша при обновлении данных
- Добавить TTL для отчётов в S3 (автоматическое удаление старых отчётов)

## Конфигурация

### application.yml

```yaml
s3:
  endpoint: ${S3_ENDPOINT:http://localhost:9000}
  access-key: ${S3_ACCESS_KEY:minioadmin}
  secret-key: ${S3_SECRET_KEY:minioadmin}
  bucket: ${S3_BUCKET:reports}
  region: ${S3_REGION:us-east-1}

cdn:
  base-url: ${CDN_BASE_URL:http://nginx-cdn}
  public-url: ${CDN_PUBLIC_URL:http://localhost:8083}
  cache-ttl: ${CDN_CACHE_TTL:3600}
```

### docker-compose.yaml

Добавлены сервисы:
- `minio` - S3-совместимое хранилище
- `nginx-cdn` - CDN с кешированием

## Преимущества решения

1. **Снижение нагрузки на ClickHouse:**
   - Запросы к базе только при генерации нового отчёта
   - Повторные запросы обслуживаются из S3

2. **Ускорение доступа:**
   - Кеширование в Nginx для быстрой отдачи
   - Статические файлы отдаются быстрее, чем динамические запросы

3. **Масштабируемость:**
   - S3 может хранить неограниченное количество отчётов
   - CDN может обслуживать множество запросов параллельно

4. **Надёжность:**
   - Отчёты сохраняются в S3, не теряются при перезапуске
   - Кеш в Nginx ускоряет доступ при сбоях

## Ограничения и улучшения

### Текущие ограничения:
1. Нет версионирования отчётов
2. Нет автоматической очистки старых отчётов
3. Нет механизма инвалидации кеша при обновлении данных

### Рекомендуемые улучшения:
1. Добавить версионирование отчётов по дате генерации
2. Реализовать TTL для отчётов в S3
3. Добавить механизм инвалидации кеша через API
4. Добавить метрики и мониторинг использования кеша
5. Оптимизировать структуру хранения для больших объёмов данных

